# -------------------- IMPORT LIBRARIES --------------------
import pandas as pd
from sklearn.model_selection import train_test_split
from sklearn.tree import DecisionTreeRegressor
from sklearn.ensemble import RandomForestRegressor
from sklearn.metrics import mean_absolute_error, mean_squared_error

# -------------------- LOAD DATA --------------------
# Replace 'min_data.csv' with your dataset path
data_path = 'min_data.csv'
data = pd.read_csv(data_path)

# Preview the data
print("First 5 rows of the dataset:\n")
print(data.head(), "\n")

# -------------------- SELECT FEATURES AND TARGET --------------------
# Update feature columns as per your dataset
features = ['LotArea', 'YearBuilt', '1stFlrSF', '2ndFlrSF',
            'FullBath', 'BedroomAbvGr', 'TotRmsAbvGrd']
target = 'SalePrice'  # Update target column if different

X = data[features]
y = data[target]

# -------------------- SPLIT DATA --------------------
train_X, val_X, train_y, val_y = train_test_split(
    X, y, test_size=0.2, random_state=42
)

# -------------------- DECISION TREE WITH TUNING --------------------
def get_mae(max_leaf_nodes, train_X, val_X, train_y, val_y):
    model = DecisionTreeRegressor(max_leaf_nodes=max_leaf_nodes, random_state=42)
    model.fit(train_X, train_y)
    preds = model.predict(val_X)
    mae = mean_absolute_error(val_y, preds)
    return mae

candidate_max_leaf_nodes = [5, 25, 50, 100, 250, 500]
best_mae = float("inf")
best_tree_size = None

for leaf_size in candidate_max_leaf_nodes:
    mae = get_mae(leaf_size, train_X, val_X, train_y, val_y)
    print(f"Max leaf nodes: {leaf_size} --> MAE: {mae:,.0f}")
    if mae < best_mae:
        best_mae = mae
        best_tree_size = leaf_size

print(f"\nBest max_leaf_nodes: {best_tree_size} with MAE: {best_mae:,.0f}\n")

# Train final Decision Tree with best leaf nodes
dt_model = DecisionTreeRegressor(max_leaf_nodes=best_tree_size, random_state=42)
dt_model.fit(train_X, train_y)
dt_val_preds = dt_model.predict(val_X)

# -------------------- RANDOM FOREST MODEL --------------------
rf_model = RandomForestRegressor(n_estimators=100, random_state=42)
rf_model.fit(train_X, train_y)
rf_val_preds = rf_model.predict(val_X)

# -------------------- EVALUATION METRICS --------------------
def print_metrics(y_true, preds, model_name):
    mae = mean_absolute_error(y_true, preds)
    rmse = mean_squared_error(y_true, preds, squared=False)
    print(f"{model_name} Metrics:")
    print(f"MAE: {mae:,.0f}")
    print(f"RMSE: {rmse:,.0f}\n")

print_metrics(val_y, dt_val_preds, "Decision Tree")
print_metrics(val_y, rf_val_preds, "Random Forest")

# -------------------- OPTIONAL: PREDICTIONS ON NEW DATA --------------------
# Uncomment if you have a separate test set
# test_data = pd.read_csv('min_test_data.csv')
# test_X = test_data[features]
# test_predictions = rf_model.predict(test_X)
# submission = pd.DataFrame({'Id': test_data['Id'], 'SalePrice': test_predictions})
# submission.to_csv('min_predictions.csv', index=False)
# print("Predictions saved to 'min_predictions.csv'")
